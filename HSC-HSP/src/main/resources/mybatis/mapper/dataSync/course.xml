<?xml version="1.0" encoding="UTF-8"?> 

<!DOCTYPE mapper 
      PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="api.dataSync.course">

	<!--
		Template 
	-->
	<sql id="tb_course_hsc">
		(
			SELECT 
				DISTINCT
				X.COURSE_ID
				, X.FMY_SITE_DS_CD
			FROM (
				SELECT
					TC.COURSE_ID
					, TC.FMY_SITE_DS_CD
				FROM
					EBSLMS_R.TB_COURSE TC
				WHERE
					1 = 1
					AND (
						(
							TC.COURSE_ID IN ('S20210000160','S20210000159','S20210000176','S20210000167','S20210000184','S20210000166','S20210000183','S20210000174','S20210000191','S20210000173','S20210000190','S20210000202','S20210000219','S20200000294')
							AND TC.FMY_SITE_DS_CD = 'EBSI'
						)
						OR
						(
							TC.COURSE_ID IN ('10030790', '10209914', '10209915', '10033681', '100001133', '100001132', '100004167', '100004295', '100004168', '100004316', '100004169', '100004296', '10210015', '10210013', '10019017', '10210014', '10019018', '10210230', '10210231', '10210233', '10209001', '10209520', '10030775', '10030777', '10030774', '10209894', '10209904', '10210063', '10034673')
							AND TC.FMY_SITE_DS_CD IN ('PRIM', 'MIDL')
						)
						OR TC.COURSE_ID IN (
							SELECT 
								TLSLC.SBJT_ID COURSE_ID
							FROM 
								EBSHSC.TB_LMS_SBJT_LECT_CAT TLSLC
							WHERE 
								TLSLC.SBJT_ID NOT IN ('S20160000941', 'S20160000691')
						)
					)
			)
				X
		)
	</sql>
	
	<sql id="tb_course_jhs">
		(
			SELECT 
				DISTINCT
				TC.COURSE_ID
				, TC.FMY_SITE_DS_CD
			FROM
				EBSLMS_R.TB_COURSE TC
			WHERE
				TC.FMY_SITE_DS_CD IN ('PRIM', 'MIDL')
				AND TC.COURSE_ID IN (
					'10030790', '10209914', '10209915', '10033681', '100001133', '100001132', '100004167', '100004295', '100004168', '100004316', '100004169', '100004296', '10210015', '10210013', '10019017', '10210014', '10019018', '10210230', '10210231', '10210233', '10209001', '10209520', '10030775', '10030777', '10030774', '10209894', '10209904', '10210063', '10034673'
				)
		)
	</sql>

	<sql id="tmp_course">
		WITH TMP_COURSE AS (
			SELECT 
				DISTINCT
				X.COURSE_ID
				, IF(X.DELT_YN IS NULL OR X.DELT_YN = '', 'N', X.DELT_YN) DELT_YN
			FROM (
				SELECT
					TC.COURSE_ID
					, TC.DELT_YN
				FROM
					EBSLMS_R.TB_COURSE TC
				WHERE
					1 = 1
					AND (
						(
							TC.COURSE_ID IN ('S20210000160','S20210000159','S20210000176','S20210000167','S20210000184','S20210000166','S20210000183','S20210000174','S20210000191','S20210000173','S20210000190','S20210000202','S20210000219','S20200000294')
							AND TC.FMY_SITE_DS_CD = 'EBSI'
						)
						OR
						(
							TC.COURSE_ID IN ('10030790', '10209914', '10209915', '10033681', '100001133', '100001132', '100004167', '100004295', '100004168', '100004316', '100004169', '100004296', '10210015', '10210013', '10019017', '10210014', '10019018', '10210230', '10210231', '10210233', '10209001', '10209520', '10030775', '10030777', '10030774', '10209894', '10209904', '10210063', '10034673')
							AND TC.FMY_SITE_DS_CD IN ('PRIM', 'MIDL')
						)
						OR TC.COURSE_ID IN (
							SELECT 
								TLSLC.SBJT_ID COURSE_ID
							FROM 
								TB_LMS_SBJT_LECT_CAT TLSLC
							WHERE 
								TLSLC.SBJT_ID NOT IN ('S20160000941', 'S20160000691')
						)
					)
			)
				X
		)
	</sql>
	
	<sql id="select_template">
		SELECT 
			A.COURSE_ID courseId
			, A.COURSE_NM courseNm
			, A.COURSE_SUBTITLE_NM courseSubtitleNm
			, (
				SELECT
					CONCAT(IF(A.FMY_SITE_DS_CD = 'EBSI', '', 'https://cbox.ebs.co.kr'), FILE_PATH_NM, FILE_PHSC_NM)
				FROM
					EBSLMS_R.TB_ATCH_FILE
				WHERE
					FILE_ID = A.FILE_ID
					AND FILE_CLS_CD = 'THUMB11'
				LIMIT 1
			) thmbPath
			, A.COURSE_FEAT courseFeat
			, A.COURSE_YEAR courseYear
			, A.COURSE_START_DT courseStartDt
			, A.COURSE_END_DT courseEndDt
			, A.COURSE_CLS_CD courseClsCd
			, A.STDY_PERIOD stdyPeriod
			, A.REVIEW_PERIOD reviewPeriod
			, A.LVL_CD lvlCd
			, A.STDY_TG_CD stdyTgCd
			, A.FMY_SITE_DS_CD fmySiteDsCd
	</sql>
	
	<sql id="from_template">
		FROM 
			EBSLMS_R.TB_COURSE A
	</sql>
	
	<sql id="where_deltYnToN_template">
		WHERE 
			IF(A.DELT_YN IS NULL OR A.DELT_YN = '', 'N', A.DELT_YN) = 'N'
	</sql>
	
	<sql id="where_deltYnToY_template">
		WHERE 
			IF(A.DELT_YN IS NULL OR A.DELT_YN = '', 'N', A.DELT_YN) = 'Y'
	</sql>
	
	<sql id="and_courseId_template">
			AND A.COURSE_ID IN (
				SELECT
					COURSE_ID
				FROM
					TMP_COURSE
			)
	</sql>
	
	<sql id="and_createDate_template">
			AND A.CREATE_DATE <![CDATA[>=]]> CONCAT(#{date}, '000000')
			AND A.CREATE_DATE <![CDATA[<=]]> CONCAT(#{date}, '235959')
	</sql>
	
	<sql id="and_editDate_template">
			AND A.EDIT_DATE <![CDATA[>=]]> CONCAT(#{date}, '000000')
			AND A.EDIT_DATE <![CDATA[<=]]> CONCAT(#{date}, '235959')
	</sql>
	
	<sql id="orderBy_template">
		ORDER BY
			A.COURSE_ID
	</sql>
	
	<!--
		Query 
	-->
	<select id="findCreateData" resultType="course" parameterType="String">
		/* api.dataSync.course.findCreateData */
		<include refid="tmp_course" />
		<include refid="select_template" />
		<include refid="from_template" />
		<include refid="where_deltYnToN_template" />
		<include refid="and_courseId_template" />
		<include refid="and_createDate_template" />
		<include refid="orderBy_template" />
	</select>
	
	<select id="findUpdateData" resultType="course" parameterType="String">
		/* api.dataSync.course.findUpdateData */
		<include refid="tmp_course" />
		<include refid="select_template" />
		<include refid="from_template" />
		<include refid="where_deltYnToN_template" />
		<include refid="and_courseId_template" />
		<include refid="and_editDate_template" />
		<include refid="orderBy_template" />
	</select>
	
	<select id="findDeleteData" resultType="courseId" parameterType="String">
		/* api.dataSync.course.findDeleteData */
		<include refid="tmp_course" />
		SELECT 
			A.COURSE_ID courseId
		<include refid="from_template" />
		<include refid="where_deltYnToY_template" />
		<include refid="and_courseId_template" />
		<include refid="and_editDate_template" />
		<include refid="orderBy_template" />
	</select>
	
</mapper>