<?xml version="1.0" encoding="UTF-8"?> 

<!DOCTYPE mapper 
      PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" 
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="api.apiEduOffice">
	
	<!-- 영상URL By LectId (EBSHSC) -->
	<select id="findVodUrlByLectId" resultType="String" parameterType="String">
		SELECT 
			CASE
		        WHEN TLLFD.CDN_URL IS NULL THEN 'NO_URL'
		    ELSE
		    	CONCAT(REPLACE(TLLFD.CDN_URL, 'http://wdwn.ebsi.nefficient.co.kr/', 'https://mstr.ebsi.nefficient.com/') , '/', SUBSTR(TM.ECD_STRM_URL, 1, INSTR(TM.ECD_STRM_URL, '_') - 1), '/', TM.ECD_STRM_URL)
		    END VOD_URL
		FROM
			EBSLMS_R.TB_LECT TL
			INNER JOIN EBSLMS_R.TB_STEP_LECT_RL TSLR ON TSLR.LECT_ID = TL.LECT_ID AND TSLR.FMY_SITE_DS_CD = TL.FMY_SITE_DS_CD
			INNER JOIN EBSLMS_R.TB_COURSE_STEP_RL TCSR ON TCSR.STEP_ID = TSLR.STEP_ID AND TCSR.FMY_SITE_DS_CD = TSLR.FMY_SITE_DS_CD
			INNER JOIN EBSLMS_R.TB_COURSE TC ON TC.COURSE_ID = TCSR.COURSE_ID AND TC.FMY_SITE_DS_CD = TCSR.FMY_SITE_DS_CD
			LEFT OUTER JOIN EBSLMS_R.TB_LECT_MEDIA_RL TLMR ON TLMR.LECT_ID = TL.LECT_ID AND TLMR.FMY_SITE_DS_CD = TL.FMY_SITE_DS_CD
			LEFT OUTER JOIN EBSLMS_R.TB_MEDIA TM ON TM.MEDIA_ID = TLMR.MEDIA_ID AND TM.FMY_SITE_DS_CD = TLMR.FMY_SITE_DS_CD
			LEFT OUTER JOIN EBSLMS_R.TB_MEDIA_ADTL_INFO TMAI ON TMAI.MEDIA_ID = TM.MEDIA_ID AND TMAI.FMY_SITE_DS_CD = TM.FMY_SITE_DS_CD
			LEFT OUTER JOIN EBSHSC.TB_LMS_LEC_FL_DOMN TLLFD ON TLLFD.DOMN_ID = TMAI.MED_DOMN AND TLLFD.LEC_GBN_CD = TM.ECD_FILE_CLS_CD
		WHERE
			TL.LECT_ID = #{lectId}
			AND TL.FMY_SITE_DS_CD = 'EBSI'
			AND (
				TC.COURSE_ID IN (
					'S20210000160', 'S20210000159', 'S20210000176', 'S20210000167', 'S20210000184', 'S20210000166', 'S20210000183', 'S20210000174', 'S20210000191', 'S20210000173', 'S20210000190', 'S20210000202', 'S20210000219', 'S20200000294'
				)
				OR EXISTS (
					SELECT 'x'
					FROM
						TB_LMS_SBJT_LECT_CAT
					WHERE
						SBJT_ID NOT IN ('S20160000941', 'S20160000691')
						AND LESSON_ID = #{lectId}
				)
			)
			AND TM.ECD_FILE_CLS_CD = 'V1M4'
			AND TM.SHW_YN = 'Y'
			AND TM.ECD_STRM_URL IS NOT NULL
		LIMIT
			1
	</select>
	
	<!-- 문항소유 주체 (EBSHSC) -->
	<select id="findFmySiteDsCdByItemId" resultType="String" parameterType="Integer">
		SELECT
			FMY_SITE_DS_CD
		FROM
			EBSITP_R.T_XIP_ITEM
		WHERE
			ITEM_ID = #{itemId}
	</select>
	
	<!-- 영상URL By ItemId (EBSPRI/EBSJHS) -->
	<select id="findVodUrlByItemIdOnFmySiteDsCd" resultType="String" parameterType="Integer">
		SELECT
			CASE
				WHEN TM.ECD_STRM_URL IS NULL OR TM.ECD_STRM_URL = '' THEN 'NO_URL'
			ELSE
				REPLACE(CONCAT(TM.ECD_STRM_URL, TM.ECD_STRM_FILE_NM), 'httpx://', 'https://')
			END VOD_URL
		FROM 
			EBSITP_R.T_XIP_ITEM TXI
			LEFT OUTER JOIN EBSITP_R.T_XIP_ITEM_QUIZ_MNG TXIQM ON TXIQM.ITEM_NO = TXI.ITEM_NO
			LEFT OUTER JOIN TB_LMS_LECT_INDEX TLLI ON TLLI.ITEM_CD = TXIQM.PCODE
			LEFT OUTER JOIN EBSLMS_R.TB_LECT_MEDIA_RL TLMR ON TLMR.LECT_ID = TLLI.LECT_ID
			LEFT OUTER JOIN EBSLMS_R.TB_MEDIA TM ON TM.MEDIA_ID = TLMR.MEDIA_ID
			LEFT OUTER JOIN EBSLMS_R.TB_LECT TLL ON TLL.LECT_ID = TLLI.LECT_ID
			LEFT OUTER JOIN EBSLMS_R.TB_STEP_LECT_RL TLSLR ON TLSLR.LECT_ID = TLL.LECT_ID
			LEFT OUTER JOIN EBSLMS_R.TB_COURSE_STEP_RL TLCSR ON TLCSR.STEP_ID = TLSLR.STEP_ID
			LEFT OUTER JOIN EBSLMS_R.TB_COURSE_ADTL_INFO TLCAI ON TLCAI.COURSE_ID = TLCSR.COURSE_ID
		WHERE 
			TXI.ITEM_ID = #{itemId}
			AND TLCAI.SHW_STE_CD = 'Y'
			AND TLCSR.SHW_YN = 'Y'
			AND TLSLR.SHW_YN = 'Y'
			AND TLL.DELT_YN = 'N'
			AND TLL.PLYR_USE_YN = 'Y'
			AND TM.ECD_FILE_CLS_CD = 'M10'
		LIMIT
			1
	</select>
	
	<!-- 영상URL By ItemId (EBSANL) -->
	<select id="findVodUrlByItemIdOnAnl" resultType="String" parameterType="Integer">
		SELECT
			LECT_URL_ADDR VOD_URL
		FROM
			TB_ITEM_LECT 
		WHERE 
			ITM_NO = #{itemId}
		LIMIT
			1
	</select>
	
	<!-- 영상URL By ItemId (EBSHSC) -->
	<select id="findVodUrlByItemId" resultType="String" parameterType="Integer">
		SELECT
			CASE 
				WHEN TLLFD.CDN_URL IS NULL THEN 'NO_URL' 
			ELSE
				CONCAT(REPLACE(TLLFD.CDN_URL, 'http://WDOWN.EBSI.CO.KR/', 'HTTPS://MSTR.EBSI.CO.KR/'), '/', SUBSTR(TM.ECD_DOWN_URL, 1, INSTR(TM.ECD_DOWN_URL, '_') - 1), '/', TM.ECD_DOWN_URL)
			END VOD_URL
		FROM (
			SELECT  
				TLI.LECT_ID
			FROM
				EBSITP_R.T_XIP_ITEM XI
				INNER JOIN EBSITP_R.T_XIP_ITEM_QUIZ_MNG XIQM ON XIQM.ITEM_NO = XI.ITEM_NO
				INNER JOIN EBSHSC.TB_TXBK_QUES TQ ON TQ.PRT_CD = XIQM.PCODE
				INNER JOIN EBSHSC.TB_INDEX_PRT_MAPNG IPM ON IPM.TXBK_QUES_ID = TQ.TXBK_QUES_ID     
				INNER JOIN EBSLMS_R.TB_LECT_ITEM TLI ON TLI.LECT_ID = IPM.LESSON_ID AND TLI.LECT_ITEM_ID = IPM.INDEX_ID
			WHERE
				XI.ITEM_NO = #{itemId}
			UNION ALL
			SELECT  
				TLI.LECT_ID
			FROM
				EBSITP_R.T_XIP_ITEM XI
				INNER JOIN EBSHSC.TB_XIP_SCV_EXPL XSE ON XSE.PRBM_NO = XI.ITEM_NO
				INNER JOIN EBSLMS_R.TB_LECT_ITEM TLI ON TLI.LECT_ID = XSE.LEC_ID AND TLI.START_TIME = XSE.EXPL_TM
			WHERE
				XI.ITEM_NO = #{itemId}
		)
			TL
			LEFT OUTER JOIN EBSLMS_R.TB_LECT_MEDIA_RL TLMR ON TLMR.LECT_ID = TL.LECT_ID
			LEFT OUTER JOIN EBSLMS_R.TB_MEDIA TM ON TM.MEDIA_ID = TLMR.MEDIA_ID AND TM.FMY_SITE_DS_CD = TLMR.FMY_SITE_DS_CD
			LEFT OUTER JOIN EBSLMS_R.TB_MEDIA_ADTL_INFO TMAI ON TMAI.MEDIA_ID = TM.MEDIA_ID AND TMAI.FMY_SITE_DS_CD = TM.FMY_SITE_DS_CD
			LEFT OUTER JOIN EBSHSC.TB_LMS_LEC_FL_DOMN TLLFD ON TLLFD.DOMN_ID = TMAI.MED_DOMN AND TLLFD.LEC_GBN_CD = TM.ECD_FILE_CLS_CD
		WHERE 
			TM.ECD_FILE_CLS_CD = 'V1M4'
			AND TM.SHW_YN = 'Y'
			AND TM.ECD_STRM_URL IS NOT NULL
		LIMIT
			1
	</select>
	
</mapper>